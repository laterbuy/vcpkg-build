name: Build FFmpeg DLL for Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ffmpeg:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-binutils
          mingw-w64-x86_64-pkg-config
          mingw-w64-x86_64-make
          mingw-w64-x86_64-diffutils
          mingw-w64-x86_64-nasm
          mingw-w64-x86_64-yasm
          make
          diffutils
          git
          
    - name: Install dependencies
      shell: msys2 {0}
      run: |
        pacman -S --noconfirm \
          mingw-w64-x86_64-x264 \
          mingw-w64-x86_64-zlib \
          mingw-w64-x86_64-bzip2 \
          mingw-w64-x86_64-lame \
          mingw-w64-x86_64-libvorbis \
          mingw-w64-x86_64-opus
          
    - name: Download FFmpeg source
      shell: msys2 {0}
      run: |
        git clone --depth 1 --branch n6.1 https://git.ffmpeg.org/ffmpeg.git
        cd ffmpeg
        
    - name: Configure FFmpeg
      shell: msys2 {0}
      run: |
        cd ffmpeg
        export PATH="/mingw64/bin:$PATH"
        ./configure \
          --prefix=/mingw64 \
          --arch=x86_64 \
          --target-os=mingw32 \
          --cross-prefix=x86_64-w64-mingw32- \
          --enable-cross-compile \
          --enable-shared \
          --disable-static \
          --disable-debug \
          --disable-doc \
          --disable-programs \
          --disable-everything \
          --enable-avcodec \
          --enable-avformat \
          --enable-avutil \
          --enable-swscale \
          --enable-swresample \
          --enable-protocol=file \
          --enable-protocol=pipe \
          --enable-protocol=http \
          --enable-protocol=https \
          --enable-protocol=tcp \
          --enable-protocol=udp \
          --enable-demuxer=mov \
          --enable-demuxer=mp4 \
          --enable-demuxer=matroska \
          --enable-demuxer=avi \
          --enable-demuxer=flv \
          --enable-muxer=mp4 \
          --enable-muxer=matroska \
          --enable-muxer=avi \
          --enable-muxer=flv \
          --enable-encoder=libx264 \
          --enable-encoder=h264_qsv \
          --enable-encoder=h264_amf \
          --enable-decoder=h264 \
          --enable-decoder=h264_qsv \
          --enable-parser=h264 \
          --enable-bsf=h264_mp4toannexb \
          --enable-bsf=h264_metadata \
          --enable-filter=scale \
          --enable-filter=fps \
          --enable-filter=format \
          --enable-filter=null \
          --enable-filter=anull \
          --enable-libx264 \
          --enable-gpl \
          --enable-version3 \
          --enable-nonfree \
          --enable-runtime-cpudetect \
          --extra-cflags="-O3" \
          --extra-ldflags="-static-libgcc -static-libstdc++"
          
    - name: Build FFmpeg
      shell: msys2 {0}
      run: |
        cd ffmpeg
        export PATH="/mingw64/bin:$PATH"
        make -j$(nproc)
        make install DESTDIR=/tmp/ffmpeg-install
        
    - name: Prepare artifacts
      shell: msys2 {0}
      run: |
        mkdir -p ffmpeg-windows-h264
        mkdir -p ffmpeg-windows-h264/bin
        mkdir -p ffmpeg-windows-h264/lib
        mkdir -p ffmpeg-windows-h264/include
        
        # Copy DLL files
        cp /tmp/ffmpeg-install/mingw64/bin/*.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/avcodec-*.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/avformat-*.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/avutil-*.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/swscale-*.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/swresample-*.dll ffmpeg-windows-h264/bin/ || true
        
        # Copy lib files
        cp /tmp/ffmpeg-install/mingw64/lib/*.dll.a ffmpeg-windows-h264/lib/ || true
        cp /tmp/ffmpeg-install/mingw64/lib/pkgconfig ffmpeg-windows-h264/lib/ -r || true
        
        # Copy headers
        cp /tmp/ffmpeg-install/mingw64/include/libav* ffmpeg-windows-h264/include/ -r || true
        cp /tmp/ffmpeg-install/mingw64/include/libsw* ffmpeg-windows-h264/include/ -r || true
        
        # Copy required MinGW DLLs
        cp /mingw64/bin/libgcc_s_seh-1.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/libwinpthread-1.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/libstdc++-6.dll ffmpeg-windows-h264/bin/ || true
        cp /mingw64/bin/libx264-*.dll ffmpeg-windows-h264/bin/ || true
        
        # Create README
        cat > ffmpeg-windows-h264/README.md << 'EOF'
        # FFmpeg Windows H.264 Build
        
        This build includes:
        - H.264 software encoding via libx264
        - H.264 hardware encoding support (QSV, AMF)
        - H.264 decoding with hardware acceleration support
        - Dynamic libraries (.dll files)
        
        ## Usage
        Add the `bin` directory to your PATH or place the DLL files alongside your application.
        
        ## Included encoders:
        - libx264 (software H.264 encoding)
        - h264_qsv (Intel Quick Sync Video)
        - h264_amf (AMD hardware encoding)
        
        ## Included decoders:
        - h264 (software decoding)
        - h264_qsv (Intel hardware decoding)
        EOF
        
        # List files for verification
        echo "Generated files:"
        find ffmpeg-windows-h264 -type f
        
    - name: Upload FFmpeg artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-windows-h264-dll
        path: ffmpeg-windows-h264/
        retention-days: 30
        
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ffmpeg-windows-h264.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
