name: Build FFmpeg DLL (x264, MSVC -test)

on:
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸ä¸Šä¼  Release èµ„äº§

jobs:
  build:
    runs-on: windows-latest

    env:
      FFMPEG_VERSION: n6.1
      BUILD_DIR: ${{ github.workspace }}\ffmpeg-build
      INSTALL_DIR: ${{ github.workspace }}\ffmpeg-output

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install build dependencies
      run: |
        choco install -y nasm
        choco install -y msys2

    - name: Build x264 with MSVC compatibility
      run: |
        # ä½¿ç”¨ ShiftMediaProject çš„ x264 for MSVC
        git clone --depth=1 https://github.com/ShiftMediaProject/x264
        cd x264
        
        # æŸ¥æ‰¾å¹¶æ„å»ºæ­£ç¡®çš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶
        if (Test-Path "SMP") { cd SMP }
        
        $solutionFile = Get-ChildItem -Filter "*.sln" | Select-Object -First 1
        if ($solutionFile) {
          Write-Host "âœ… æ‰¾åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶: $($solutionFile.Name)"
          msbuild $solutionFile.Name /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°è§£å†³æ–¹æ¡ˆæ–‡ä»¶ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
          # ä½¿ç”¨vcpkgå®‰è£…x264
          cd ..
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg.exe install x264:x64-windows
          
          # å¤åˆ¶vcpkgæ„å»ºçš„x264æ–‡ä»¶
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/bin/x64/Release"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/lib/x64/Release"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/include"
          
          Copy-Item "installed/x64-windows/bin/x264*.dll" "${{ github.workspace }}/x264/bin/x64/Release/" -ErrorAction SilentlyContinue
          Copy-Item "installed/x64-windows/lib/x264.lib" "${{ github.workspace }}/x264/lib/x64/Release/" -ErrorAction SilentlyContinue
          Copy-Item "installed/x64-windows/include/x264*" "${{ github.workspace }}/x264/include/" -ErrorAction SilentlyContinue
        }
        cd ..

    - name: Setup Hardware Encoder Dependencies
      run: |
        # åˆ›å»ºç¡¬ä»¶ç¼–ç å™¨ç›®å½•
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/hardware-encoders/include"
        
        # ä¸‹è½½ NVIDIA Video Codec SDK (NVENC æ”¯æŒ)
        Write-Host "ğŸ”½ ä¸‹è½½ NVIDIA Video Codec SDK..."
        curl -L -o nvcodec-headers.zip https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.zip
        Expand-Archive -Path nvcodec-headers.zip -DestinationPath .
        Copy-Item "nv-codec-headers-master\include\*" "${{ github.workspace }}\hardware-encoders\include\" -Recurse -Force
        
        # ä¸‹è½½ Intel Media SDK (QSV æ”¯æŒ)
        Write-Host "ğŸ”½ ä¸‹è½½ Intel Media SDK..."
        git clone --depth=1 https://github.com/Intel-Media-SDK/MediaSDK intel-media-sdk
        if (Test-Path "intel-media-sdk\api\include") {
          Copy-Item "intel-media-sdk\api\include\*" "${{ github.workspace }}\hardware-encoders\include\" -Recurse -Force
        }
        
        # ä¸‹è½½ AMD Media Framework (AMF æ”¯æŒ) 
        Write-Host "ğŸ”½ ä¸‹è½½ AMD Media Framework..."
        curl -L -o amf-headers.zip https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/heads/master.zip
        Expand-Archive -Path amf-headers.zip -DestinationPath .
        Rename-Item -Path "AMF-master" -NewName "amf"
        if (Test-Path "amf\amf\public\include") {
          Copy-Item "amf\amf\public\include\*" "${{ github.workspace }}\hardware-encoders\include\" -Recurse -Force
        }

    - name: Clone FFmpeg
      run: |
        git clone --depth=1 https://github.com/FFmpeg/FFmpeg -b $env:FFMPEG_VERSION ffmpeg

    - name: Configure and Build FFmpeg with MSVC
      run: |
        cd ffmpeg
        
        # è®¾ç½®MSYS2ç¯å¢ƒç”¨äºconfigureå’Œmake
        $env:PATH = "C:\tools\msys64\usr\bin;$env:PATH"
        
        # è½¬æ¢è·¯å¾„æ ¼å¼ 
        $workspace = (Get-Location).Path.Replace('\', '/').Replace('C:', '/c').Replace('D:', '/d').Replace('E:', '/e')
        
        Write-Host "ğŸ”§ é…ç½®FFmpeg..."
        
        # FFmpeg configure - ä½¿ç”¨MSVCå·¥å…·é“¾
        bash -c "./configure --enable-shared --disable-static --enable-libx264 --enable-nvenc --enable-qsv --enable-amf --enable-cuda-nvcc --enable-cuvid --enable-d3d11va --enable-dxva2 --toolchain=msvc --target-os=win64 --arch=x86_64 --prefix=$workspace/../ffmpeg-output --extra-cflags='-I$workspace/../hardware-encoders/include -I$workspace/../x264/include' --extra-ldflags='-L$workspace/../x264/lib/x64/Release' --extra-libs='-lx264'"
        
        Write-Host "ğŸ”¨ æ„å»ºFFmpeg..."
        bash -c "make -j4"
        bash -c "make install"

    - name: Organize output and create build info
      run: |
        Write-Host "ğŸ“¦ æ•´ç†è¾“å‡ºæ–‡ä»¶..."
        
        # åˆ›å»ºæ›´å¥½çš„ç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\ffmpeg-output\include\x264"
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\ffmpeg-output\include\hardware-encoders"
        
        # å¤åˆ¶x264æ–‡ä»¶åˆ°å­ç›®å½•
        if (Test-Path "x264\bin\x64\Release") {
          Copy-Item "x264\bin\x64\Release\*" "${{ github.workspace }}\ffmpeg-output\bin\" -Force -Recurse -ErrorAction SilentlyContinue
        }
        if (Test-Path "x264\lib\x64\Release") {
          Copy-Item "x264\lib\x64\Release\*" "${{ github.workspace }}\ffmpeg-output\lib\" -Force -Recurse -ErrorAction SilentlyContinue
        }
        if (Test-Path "x264\include") {
          Copy-Item "x264\include\*" "${{ github.workspace }}\ffmpeg-output\include\x264\" -Force -Recurse -ErrorAction SilentlyContinue
        }
        
        # å¤åˆ¶ç¡¬ä»¶ç¼–ç å™¨å¤´æ–‡ä»¶åˆ°å­ç›®å½•
        if (Test-Path "hardware-encoders\include") {
          Copy-Item "hardware-encoders\include\*" "${{ github.workspace }}\ffmpeg-output\include\hardware-encoders\" -Force -Recurse -ErrorAction SilentlyContinue
        }
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
        $buildInfo = @"
FFmpeg Build Information
========================
FFmpeg Version: 6.1
Build Time: $buildTime
Compiler: MSVC (Visual Studio 2022)
Platform: Windows x64
Architecture: x86_64

Hardware Encoders:
- âœ… NVIDIA NVENC (h264_nvenc) - NVIDIA GPU ç¡¬ä»¶ç¼–ç 
- âœ… Intel QSV (h264_qsv) - Intel Quick Sync Video  
- âœ… AMD AMF (h264_amf) - AMD Media Framework
- âœ… x264 (libx264) - è½¯ä»¶ç¼–ç å›é€€

Additional Features:
- CUDA acceleration
- D3D11VA/DXVA2 hardware decoding
- Shared libraries (.dll)
- MSVC-compatible import libraries (.lib)

Directory Structure:
â”œâ”€â”€ bin/          # DLL files
â”œâ”€â”€ lib/          # Import libraries (.lib)
â””â”€â”€ include/      # Header files
    â”œâ”€â”€ ffmpeg/   # FFmpeg headers
    â”œâ”€â”€ x264/     # x264 headers  
    â””â”€â”€ hardware-encoders/ # Hardware encoder headers

Usage:
Link against the .lib files and ensure .dll files are in your PATH.
"@
        
        $buildInfo | Out-File -FilePath "${{ github.workspace }}\ffmpeg-output\build-info.txt" -Encoding UTF8
        
        Write-Host "âœ… æ„å»ºå®Œæˆï¼"

    - name: Archive build
      run: |
        Compress-Archive -Path ${{ github.workspace }}\ffmpeg-output\* -DestinationPath ffmpeg-hardware-encoders.zip

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ffmpeg-hardware-encoders.zip
        tag_name: ffmpeg-hw-encoders-${{ github.run_number }}
        name: "FFmpeg with Hardware Encoders (NVENC/QSV/AMF) - Build ${{ github.run_number }}"
        body: |
          ğŸš€ **FFmpeg with Hardware Encoders Support**
          
          åŒ…å«çš„ç¡¬ä»¶ç¼–ç å™¨:
          - âœ… **NVIDIA NVENC** (h264_nvenc) - NVIDIA GPU ç¡¬ä»¶ç¼–ç 
          - âœ… **Intel QSV** (h264_qsv) - Intel Quick Sync Video
          - âœ… **AMD AMF** (h264_amf) - AMD Media Framework
          - âœ… **x264** (libx264) - è½¯ä»¶ç¼–ç å›é€€
          
          æ”¯æŒçš„åŠŸèƒ½:
          - H.264 ç¡¬ä»¶ç¼–ç  (NVENC/QSV/AMF)
          - H.264 è½¯ä»¶ç¼–ç  (x264)
          - CUDA åŠ é€Ÿ
          - D3D11VA/DXVA2 ç¡¬ä»¶è§£ç 
          
          **æ„å»ºä¿¡æ¯:**
          - FFmpeg ç‰ˆæœ¬: 6.1
          - å¹³å°: Windows x64 
          - ç¼–è¯‘å™¨: MSVC
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
