name: Build FFmpeg DLL (x264, MSVC -test)

on:
  workflow_dispatch:

permissions:
  contents: write  # 允许上传 Release 资产

jobs:
  build:
    runs-on: windows-latest

    env:
      FFMPEG_VERSION: n6.1
      BUILD_DIR: ${{ github.workspace }}\ffmpeg-build
      INSTALL_DIR: ${{ github.workspace }}\ffmpeg-output

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install MSYS2 for build tools
      run: |
        choco install -y msys2

    - name: Install dependencies and build x264
      run: |
        choco install -y nasm
        
        # 设置MSYS2环境
        $env:PATH = "C:\tools\msys64\usr\bin;C:\tools\msys64\mingw64\bin;$env:PATH"
        
        # 使用原版x264构建（更可靠）
        git clone --depth=1 https://github.com/mirror/x264 x264-source
        cd x264-source
        
        # 配置并构建x264
        bash -c "./configure --enable-shared --enable-pic --prefix=${{ github.workspace }}/x264-build --enable-win32thread"
        bash -c "make -j4"
        bash -c "make install"
        
        # 创建目录结构以匹配后续步骤
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/bin/x64/Release"
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/lib/x64/Release" 
        New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/x264/include"
        
        # 复制构建结果
        if (Test-Path "${{ github.workspace }}/x264-build/bin") {
          Copy-Item "${{ github.workspace }}/x264-build/bin/*" "${{ github.workspace }}/x264/bin/x64/Release/" -Force -Recurse
        }
        if (Test-Path "${{ github.workspace }}/x264-build/lib") {
          Copy-Item "${{ github.workspace }}/x264-build/lib/*" "${{ github.workspace }}/x264/lib/x64/Release/" -Force -Recurse  
        }
        if (Test-Path "${{ github.workspace }}/x264-build/include") {
          Copy-Item "${{ github.workspace }}/x264-build/include/*" "${{ github.workspace }}/x264/include/" -Force -Recurse
        }
        
        cd ..

    - name: Setup Hardware Encoder Dependencies
      run: |
        # 设置MSYS2环境
        $env:PATH = "C:\tools\msys64\usr\bin;$env:PATH"
        
        # 下载 NVIDIA Video Codec SDK (NVENC 支持)
        curl -L -o nvcodec-headers.zip https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.zip
        Expand-Archive -Path nvcodec-headers.zip -DestinationPath .
        cd nv-codec-headers-master
        bash -c "make install PREFIX=${{ github.workspace }}/nvcodec"
        cd ..
        
        # 下载 Intel Media SDK (QSV 支持)
        git clone --depth=1 https://github.com/Intel-Media-SDK/MediaSDK intel-media-sdk
        
        # 下载 AMD Media Framework (AMF 支持) 
        curl -L -o amf-headers.zip https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/heads/master.zip
        Expand-Archive -Path amf-headers.zip -DestinationPath .
        Rename-Item -Path "AMF-master" -NewName "amf"

    - name: Clone FFmpeg
      run: |
        git clone --depth=1 https://github.com/FFmpeg/FFmpeg -b $env:FFMPEG_VERSION ffmpeg

    - name: Configure FFmpeg for Hardware Encoders
      run: |
        cd ffmpeg
        
        # 设置MSYS2环境
        $env:PATH = "C:\tools\msys64\usr\bin;C:\tools\msys64\mingw64\bin;$env:PATH"
        
        # 设置硬件编码器环境变量
        $env:NVCODEC_PATH = "${{ github.workspace }}/nvcodec"
        $env:INTELMEDIASDKROOT = "${{ github.workspace }}/intel-media-sdk"  
        $env:AMF_PATH = "${{ github.workspace }}/amf"
        
        # 配置FFmpeg以启用硬件编码器
        bash -c "./configure --enable-shared --disable-static --enable-libx264 --enable-nvenc --enable-qsv --enable-amf --enable-cuda-nvcc --enable-cuvid --enable-d3d11va --enable-dxva2 --toolchain=msvc --arch=x86_64 --prefix=${{ github.workspace }}/ffmpeg-output --extra-cflags='-I${{ github.workspace }}/nvcodec/include -I${{ github.workspace }}/intel-media-sdk/include -I${{ github.workspace }}/amf/amf/public/include' --extra-ldflags='-L${{ github.workspace }}/x264/lib/x64/Release' --extra-libs='-lx264'"

    - name: Build FFmpeg DLL (Release x64)
      run: |
        cd ffmpeg
        
        # 设置MSYS2环境
        $env:PATH = "C:\tools\msys64\usr\bin;C:\tools\msys64\mingw64\bin;$env:PATH"
        
        bash -c "make -j4"
        bash -c "make install"

    - name: Collect DLLs, LIBs, and headers
      run: |
        # FFmpeg文件已经安装到 ffmpeg-output 目录
        # 复制x264库文件
        xcopy /Y /S x264\bin\x64\Release\*.dll ${{ github.workspace }}\ffmpeg-output\bin\
        xcopy /Y /S x264\lib\x64\Release\*.lib ${{ github.workspace }}\ffmpeg-output\lib\
        xcopy /Y /S x264\include\* ${{ github.workspace }}\ffmpeg-output\include\
        
        # 复制硬件编码器头文件
        xcopy /Y /S nvcodec\include\* ${{ github.workspace }}\ffmpeg-output\include\
        xcopy /Y /S intel-media-sdk\include\* ${{ github.workspace }}\ffmpeg-output\include\
        xcopy /Y /S amf\amf\public\include\* ${{ github.workspace }}\ffmpeg-output\include\

    - name: Archive build
      run: |
        Compress-Archive -Path ${{ github.workspace }}\ffmpeg-output\* -DestinationPath ffmpeg-hardware-encoders.zip

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ffmpeg-hardware-encoders.zip
        tag_name: ffmpeg-hw-encoders-${{ github.run_number }}
        name: "FFmpeg with Hardware Encoders (NVENC/QSV/AMF) - Build ${{ github.run_number }}"
        body: |
          🚀 **FFmpeg with Hardware Encoders Support**
          
          包含的硬件编码器:
          - ✅ **NVIDIA NVENC** (h264_nvenc) - NVIDIA GPU 硬件编码
          - ✅ **Intel QSV** (h264_qsv) - Intel Quick Sync Video
          - ✅ **AMD AMF** (h264_amf) - AMD Media Framework
          - ✅ **x264** (libx264) - 软件编码回退
          
          支持的功能:
          - H.264 硬件编码 (NVENC/QSV/AMF)
          - H.264 软件编码 (x264)
          - CUDA 加速
          - D3D11VA/DXVA2 硬件解码
          
          **构建信息:**
          - FFmpeg 版本: 6.1
          - 平台: Windows x64 
          - 编译器: MSVC
          - 构建时间: ${{ github.event.head_commit.timestamp }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
