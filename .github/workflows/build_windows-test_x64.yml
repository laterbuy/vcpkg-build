name: Build FFmpeg DLL (x264, MSVC)

on:
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸ä¸Šä¼  Release èµ„äº§

jobs:
  build:
    runs-on: windows-latest

    env:
      FFMPEG_VERSION: n6.1
      BUILD_DIR: ${{ github.workspace }}\ffmpeg-build
      INSTALL_DIR: ${{ github.workspace }}\ffmpeg-output

    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies
      run: |
        choco install -y nasm
        git clone --depth=1 https://github.com/ShiftMediaProject/x264
        cd x264
        msbuild x264.sln /p:Configuration=Release /p:Platform=x64
        cd ..

    - name: Install MSYS2 for FFmpeg build
      run: |
        choco install -y msys2

    - name: Setup Hardware Encoder Dependencies
      run: |
        # è®¾ç½®MSYS2ç¯å¢ƒ
        $env:PATH = "C:\tools\msys64\usr\bin;$env:PATH"
        
        # ä¸‹è½½ NVIDIA Video Codec SDK (NVENC æ”¯æŒ)
        curl -L -o nvcodec-headers.zip https://github.com/FFmpeg/nv-codec-headers/archive/refs/heads/master.zip
        Expand-Archive -Path nvcodec-headers.zip -DestinationPath .
        cd nv-codec-headers-master
        bash -c "make install PREFIX=${{ github.workspace }}/nvcodec"
        cd ..
        
        # ä¸‹è½½ Intel Media SDK (QSV æ”¯æŒ)
        git clone --depth=1 https://github.com/Intel-Media-SDK/MediaSDK intel-media-sdk
        
        # ä¸‹è½½ AMD Media Framework (AMF æ”¯æŒ) 
        curl -L -o amf-headers.zip https://github.com/GPUOpen-LibrariesAndSDKs/AMF/archive/refs/heads/master.zip
        Expand-Archive -Path amf-headers.zip -DestinationPath .
        Rename-Item -Path "AMF-master" -NewName "amf"

    - name: Clone FFmpeg and FFVS Generator
      run: |
        git clone --depth=1 https://github.com/FFVS/FFVS-Project-Generator FFVS
        git clone --depth=1 https://github.com/FFmpeg/FFmpeg -b %FFMPEG_VERSION% ffmpeg

    - name: Generate FFmpeg Project with DLL output
      run: |
        cd FFVS
        # ç”Ÿæˆå¸¦ç¡¬ä»¶ç¼–ç å™¨æ”¯æŒçš„FFmpegé¡¹ç›®
        .\GenerateFFmpegProject.bat ..\ffmpeg ..\x264 dll --enable-nvenc --enable-qsv --enable-amf

    - name: Configure FFmpeg for Hardware Encoders
      run: |
        cd ffmpeg
        
        # è®¾ç½®MSYS2ç¯å¢ƒ
        $env:PATH = "C:\tools\msys64\usr\bin;C:\tools\msys64\mingw64\bin;$env:PATH"
        
        # è®¾ç½®ç¡¬ä»¶ç¼–ç å™¨ç¯å¢ƒå˜é‡
        $env:NVCODEC_PATH = "${{ github.workspace }}/nvcodec"
        $env:INTELMEDIASDKROOT = "${{ github.workspace }}/intel-media-sdk"  
        $env:AMF_PATH = "${{ github.workspace }}/amf"
        
        # é…ç½®FFmpegä»¥å¯ç”¨ç¡¬ä»¶ç¼–ç å™¨
        bash -c "./configure --enable-shared --disable-static --enable-libx264 --enable-nvenc --enable-qsv --enable-amf --enable-cuda-nvcc --enable-cuvid --enable-d3d11va --enable-dxva2 --toolchain=msvc --arch=x86_64 --prefix=${{ github.workspace }}/ffmpeg-output --extra-cflags='-I${{ github.workspace }}/nvcodec/include -I${{ github.workspace }}/intel-media-sdk/include -I${{ github.workspace }}/amf/amf/public/include' --extra-ldflags='-L${{ github.workspace }}/x264/lib/x64/Release' --extra-libs='-lx264'"

    - name: Build FFmpeg DLL (Release x64)
      run: |
        cd ffmpeg
        
        # è®¾ç½®MSYS2ç¯å¢ƒ
        $env:PATH = "C:\tools\msys64\usr\bin;C:\tools\msys64\mingw64\bin;$env:PATH"
        
        bash -c "make -j4"
        bash -c "make install"

    - name: Collect DLLs, LIBs, and headers
      run: |
        # FFmpegæ–‡ä»¶å·²ç»å®‰è£…åˆ° ffmpeg-output ç›®å½•
        # å¤åˆ¶x264åº“æ–‡ä»¶
        xcopy /Y /S x264\bin\x64\Release\*.dll ${{ github.workspace }}\ffmpeg-output\bin\
        xcopy /Y /S x264\lib\x64\Release\*.lib ${{ github.workspace }}\ffmpeg-output\lib\
        xcopy /Y /S x264\include\* ${{ github.workspace }}\ffmpeg-output\include\
        
        # å¤åˆ¶ç¡¬ä»¶ç¼–ç å™¨å¤´æ–‡ä»¶
        xcopy /Y /S nvcodec\include\* ${{ github.workspace }}\ffmpeg-output\include\
        xcopy /Y /S intel-media-sdk\include\* ${{ github.workspace }}\ffmpeg-output\include\
        xcopy /Y /S amf\amf\public\include\* ${{ github.workspace }}\ffmpeg-output\include\

    - name: Archive build
      run: |
        Compress-Archive -Path ${{ github.workspace }}\ffmpeg-output\* -DestinationPath ffmpeg-hardware-encoders.zip

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ffmpeg-hardware-encoders.zip
        tag_name: ffmpeg-hw-encoders-${{ github.run_number }}
        name: "FFmpeg with Hardware Encoders (NVENC/QSV/AMF) - Build ${{ github.run_number }}"
        body: |
          ğŸš€ **FFmpeg with Hardware Encoders Support**
          
          åŒ…å«çš„ç¡¬ä»¶ç¼–ç å™¨:
          - âœ… **NVIDIA NVENC** (h264_nvenc) - NVIDIA GPU ç¡¬ä»¶ç¼–ç 
          - âœ… **Intel QSV** (h264_qsv) - Intel Quick Sync Video
          - âœ… **AMD AMF** (h264_amf) - AMD Media Framework
          - âœ… **x264** (libx264) - è½¯ä»¶ç¼–ç å›é€€
          
          æ”¯æŒçš„åŠŸèƒ½:
          - H.264 ç¡¬ä»¶ç¼–ç  (NVENC/QSV/AMF)
          - H.264 è½¯ä»¶ç¼–ç  (x264)
          - CUDA åŠ é€Ÿ
          - D3D11VA/DXVA2 ç¡¬ä»¶è§£ç 
          
          **æ„å»ºä¿¡æ¯:**
          - FFmpeg ç‰ˆæœ¬: 6.1
          - å¹³å°: Windows x64 
          - ç¼–è¯‘å™¨: MSVC
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
